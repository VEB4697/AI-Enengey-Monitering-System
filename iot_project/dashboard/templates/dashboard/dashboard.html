{% extends 'base.html' %}
{% load static %}

{% block title %}My Dashboard{% endblock %}

{% block head_extra %}
<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;700&display=swap"
    rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<style>
    /* Custom CSS from homepage.html */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        /* IoT Theme Colors */
        --background: hsl(222, 47%, 4%);
        --foreground: hsl(210, 40%, 98%);
        --card: hsla(222, 47%, 8%, 0.6);
        /* Use hsla for transparency */
        --card-foreground: hsl(210, 40%, 98%);
        --primary: hsl(195, 100%, 50%);
        /* Main accent blue */
        --primary-foreground: hsl(222, 47%, 4%);
        --secondary: hsl(260, 60%, 65%);
        /* Purple accent */
        --accent: hsl(180, 100%, 50%);
        /* Cyan accent */
        --muted: hsl(222, 47%, 12%);
        /* Muted background */
        --muted-foreground: hsl(215, 20%, 65%);
        /* Muted text */
        --border: hsl(222, 47%, 20%);
        --input: hsl(222, 47%, 12%);
        --destructive: hsl(0, 84%, 60%);

        /* Gradients */
        --gradient-primary: linear-gradient(135deg, var(--primary), var(--secondary));
        --gradient-cyber: linear-gradient(45deg, var(--primary), var(--accent));
        --gradient-glass: linear-gradient(135deg, hsla(222, 47%, 8%, 0.8), hsla(222, 47%, 12%, 0.4));
        --gradient-opposite: linear-gradient(135deg, hsl(85, 100%, 50%), var(--accent));

        /* Effects */
        --shadow-cyber: 0 0 30px hsla(195, 100%, 50%, 0.3);
        --shadow-glass: 0 8px 32px hsla(222, 47%, 4%, 0.3);
    }

    body {
        font-family: 'Inter', sans-serif;
        background: var(--background);
        color: var(--foreground);
        min-height: 100vh;
        overflow-x: hidden;
        position: relative;
    }

    /* Enhanced Background Effects */
    body::before {
        content: '';
        position: fixed;
        inset: 0;
        background-image:
            radial-gradient(circle at 20% 80%, hsla(195, 100%, 50%, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, hsla(260, 60%, 65%, 0.1) 0%, transparent 50%),
            linear-gradient(0deg, hsla(195, 100%, 50%, 0.08) 1px, transparent 1px),
            linear-gradient(90deg, hsla(195, 100%, 50%, 0.08) 1px, transparent 1px);
        background-size: 100% 100%, 100% 100%, 60px 60px, 60px 60px;
        background-position: 0% 0%, 0% 0%, 0 0, 0 0;
        opacity: 0.9;
        z-index: -2;
        animation: subtle-gradient-shift 20s ease-in-out infinite alternate;
    }

    /* Animated background grid effect - more pronounced */
    .animated-grid {
        position: absolute;
        inset: 0;
        background-image:
            linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
        background-size: 50px 50px;
        z-index: -1;
        animation: pan-grid 60s linear infinite;
        opacity: 0.5;
    }

    @keyframes pan-grid {
        0% {
            background-position: 0 0;
        }

        100% {
            background-position: -50px -50px;
        }
    }

    /* Scanline effect for retro tech feel */
    body::after {
        content: '';
        position: fixed;
        inset: 0;
        background: repeating-linear-gradient(to bottom,
                transparent 0px,
                transparent 1px,
                rgba(0, 0, 0, 0.03) 1px,
                rgba(0, 0, 0, 0.03) 2px);
        pointer-events: none;
        z-index: 9999;
        opacity: 0.05;
    }

    .container-fluid-custom {
        position: relative;
        z-index: 10;
        padding: 2rem;
    }

    .card-custom {
        background: var(--gradient-glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        box-shadow: var(--shadow-glass);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card-custom:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 45px hsla(222, 47%, 4%, 0.5);
    }

    .card-title-custom {
        font-family: 'Orbitron', sans-serif;
        background: var(--gradient-cyber);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .card-subtitle-custom {
        color: var(--muted-foreground);
    }

    .badge-online {
        background-color: var(--accent) !important;
        color: var(--background);
        font-weight: 600;
        animation: pulse 2s infinite;
    }

    .badge-offline {
        background-color: var(--destructive) !important;
        color: var(--foreground);
        font-weight: 600;
    }

    .badge-on {
        background-color: var(--primary) !important;
        color: var(--primary-foreground);
        font-weight: 600;
    }

    .badge-off {
        background-color: var(--destructive) !important;
        color: var(--foreground);
        font-weight: 600;
    }

    .btn-custom {
        padding: 0.8rem 1.8rem;
        border: none;
        border-radius: 0.6rem;
        font-size: 1.05rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        text-decoration: none;
        outline: none;
    }

    .btn-outline-custom {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--foreground);
    }

    .btn-outline-custom:hover {
        border-color: var(--primary);
        background: hsla(195, 100%, 50%, 0.15);
        color: var(--primary);
    }

    .btn-outline-primary-custom {
        background: transparent;
        border: 1px solid var(--primary);
        color: var(--primary);
    }

    .btn-outline-primary-custom:hover {
        background: hsla(195, 100%, 50%, 0.2);
        color: var(--foreground);
    }

    .text-light {
        color: var(--foreground) !important;
        font-family: 'Orbitron', sans-serif;
        font-size: 2.5rem;
        background: var(--gradient-cyber);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 2rem;
    }

    /* Animations */
    @keyframes subtle-gradient-shift {
        0% {
            background-position: 0% 0%, 0% 0%, 0% 0%, 0 0, 0 0;
        }

        100% {
            background-position: 100% 100%, 100% 100%, 100% 100%, 100% 100%, 100% 100%;
        }
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(var(--accent-rgb), 0.7);
        }

        70% {
            transform: scale(1.05);
            box-shadow: 0 0 0 10px rgba(var(--accent-rgb), 0);
        }

        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(var(--accent-rgb), 0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="animated-grid"></div>
<div class="container-fluid-custom">
    <h2 class="mb-4 text-light">My Smart Devices</h2>

    {% if devices_with_latest_data %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for item in devices_with_latest_data %}
        <div class="col" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:1 }}00">
            <div class="card-custom h-100 p-4" data-device-id="{{ item.device.id }}">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title-custom">{{ item.device.name }}</h5>
                    <h6 class="card-subtitle-custom mb-3">{{ item.device.get_device_type_display }}</h6>

                    <p class="mb-2">
                        <strong class="text-white">Status:</strong>
                        {% if item.device.is_online %} {# Changed to item.device.is_online #}
                        <span class="badge badge-online">Online</span>
                        {% else %}
                        <span class="badge badge-offline">Offline</span>
                        {% endif %}
                    </p>
                    <p class="card-text mb-3" style="font-size: 0.9rem; color: var(--muted-foreground);">
                        <strong class="text-white">Last Seen:</strong> <span class="last-seen-text">{{ item.device.last_seen|default:"N/A" }}</span>
                    </p>

                    <div class="mt-auto">
                        {% if item.device.device_type == 'power_monitor' %}
                        <p class="card-text">
                            <strong class="text-white">Current Power:</strong> <span class="power-value" style="color: var(--primary);">
                                {{ item.latest_data.power|default:"N/A" }}</span> W<br>
                            <strong class="text-white">Voltage:</strong> <span class="voltage-value" style="color: var(--primary);">
                                {{ item.latest_data.voltage|default:"N/A" }}</span> V<br>
                            <strong class="text-white">Relay State:</strong>
                            {# Simplified relay state check. Assumes latest_data.relay_state is a boolean from backend #}
                            {% if item.latest_data.relay_state %}
                            <span class="badge badge-on relay-badge">ON</span>
                            {% else %}
                            <span class="badge badge-off relay-badge">OFF</span>
                            {% endif %}
                        </p>
                        {% elif item.device.device_type == 'water_level' %}
                        <p class="card-text">
                            <strong class="text-white">Water Level:</strong> <span style="color: var(--primary);">
                                {{item.latest_data.water_level|default:"N/A" }}</span>% {# Removed .get #}
                        </p>
                        {% else %}
                        <p class="card-text text-muted">No specific data available for this device type.</p>
                        {% endif %}
                    </div>
                    <a href="{% url 'dashboard:device_detail' item.device.id %}"
                        class="btn-custom btn-outline-primary-custom mt-3">View Details & Control</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info text-center" role="alert"
        style="background: var(--gradient-glass); border-color: var(--primary); color: var(--foreground);">
        You don't have any devices registered yet. <a href="{% url 'add_device_to_user' %}" class="alert-link"
            style="color: var(--primary);">Set up a new device</a> to get started!
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true,
            mirror: false
        });

        // Function to format the timestamp
        function formatLastSeen(timestamp) {
            if (!timestamp || timestamp === 'N/A') return 'N/A';
            const date = new Date(timestamp);
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            return date.toLocaleString('en-US', options);
        }

        // Function to fetch and update data
        function updateDashboard() {
            const deviceCards = document.querySelectorAll('.card-custom');
            deviceCards.forEach(card => {
                const deviceId = card.getAttribute('data-device-id');
                if (!deviceId) return;

                // IMPORTANT: Ensure this API endpoint exists in your Django backend (device_api/urls.py and views.py).
                // It should return JSON like:
                // {
                //   "device": { "id": 1, "is_online": true, "last_seen": "2025-08-10T22:30:00Z", "device_type": "power_monitor" },
                //   "latest_data": { "power": 123.4, "voltage": 240.5, "relay_state": true }
                // }
                fetch(`/api/v1/device/${deviceId}/latest_data/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data) {
                            // Update last seen and status
                            const lastSeenElement = card.querySelector('.last-seen-text');
                            if (lastSeenElement) {
                                lastSeenElement.textContent = formatLastSeen(data.device.last_seen);
                            }
                            const statusBadge = card.querySelector('.badge');
                            if (statusBadge) {
                                if (data.device.is_online) {
                                    statusBadge.textContent = 'Online';
                                    statusBadge.className = 'badge badge-online';
                                } else {
                                    statusBadge.textContent = 'Offline';
                                    statusBadge.className = 'badge badge-offline';
                                }
                            }

                            // Update sensor data for power_monitor
                            if (data.device.device_type === 'power_monitor' && data.latest_data) {
                                const powerElement = card.querySelector('.power-value');
                                const voltageElement = card.querySelector('.voltage-value');
                                const relayBadge = card.querySelector('.relay-badge');

                                if (powerElement) powerElement.textContent = data.latest_data.power || 'N/A';
                                if (voltageElement) voltageElement.textContent = data.latest_data.voltage || 'N/A';

                                if (relayBadge) {
                                    // Handle relay_state which can be boolean or string ('true'/'false' or 'on'/'off')
                                    // Convert to lowercase string for robust comparison
                                    const relayState = String(data.latest_data.relay_state).toLowerCase();
                                    if (relayState === 'true' || relayState === 'on') {
                                        relayBadge.textContent = 'ON';
                                        relayBadge.className = 'badge badge-on relay-badge'; // Keep relay-badge class
                                    } else {
                                        relayBadge.textContent = 'OFF';
                                        relayBadge.className = 'badge badge-off relay-badge'; // Keep relay-badge class
                                    }
                                }
                            }
                            // Add similar logic for other device types (e.g., water_level) if needed
                            if (data.device.device_type === 'water_level' && data.latest_data) {
                                const waterLevelElement = card.querySelector('.water-level-value'); // Assuming a class for water level
                                if (waterLevelElement) waterLevelElement.textContent = data.latest_data.water_level || 'N/A';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching latest data for device', deviceId, ':', error);
                    });
            });
        }

        // Run the update function initially
        updateDashboard();

        // Run the update function every 5 seconds (5000 milliseconds)
        setInterval(updateDashboard, 5000);
    });
</script>
{% endblock %}
