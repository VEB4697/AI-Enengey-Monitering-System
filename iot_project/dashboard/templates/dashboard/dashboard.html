{% extends 'base.html' %}
{% load static %}

{% block title %}My Dashboard{% endblock %}

{% block head_extra %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<style>
    /* Custom CSS from homepage.html */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        /* IoT Theme Colors */
        --background: hsl(222, 47%, 4%);
        --foreground: hsl(210, 40%, 98%);
        --card: hsla(222, 47%, 8%, 0.6); /* Use hsla for transparency */
        --card-foreground: hsl(210, 40%, 98%);
        --primary: hsl(195, 100%, 50%); /* Main accent blue */
        --primary-foreground: hsl(222, 47%, 4%);
        --secondary: hsl(260, 60%, 65%); /* Purple accent */
        --accent: hsl(180, 100%, 50%); /* Cyan accent */
        --muted: hsl(222, 47%, 12%); /* Muted background */
        --muted-foreground: hsl(215, 20%, 65%); /* Muted text */
        --border: hsl(222, 47%, 20%);
        --input: hsl(222, 47%, 12%);
        --destructive: hsl(0, 84%, 60%);

        /* Gradients */
        --gradient-primary: linear-gradient(135deg, var(--primary), var(--secondary));
        --gradient-cyber: linear-gradient(45deg, var(--primary), var(--accent));
        --gradient-glass: linear-gradient(135deg, hsla(222, 47%, 8%, 0.8), hsla(222, 47%, 12%, 0.4));
        --gradient-opposite: linear-gradient(135deg, hsl(85, 100%, 50%), var(--accent));

        /* Effects */
        --shadow-cyber: 0 0 30px hsla(195, 100%, 50%, 0.3);
        --shadow-glass: 0 8px 32px hsla(222, 47%, 4%, 0.3);
    }

    body {
        font-family: 'Inter', sans-serif;
        background: var(--background);
        color: var(--foreground);
        min-height: 100vh;
        overflow-x: hidden;
        position: relative;
    }

    /* Enhanced Background Effects */
    body::before {
        content: '';
        position: fixed;
        inset: 0;
        background-image:
            radial-gradient(circle at 20% 80%, hsla(195, 100%, 50%, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, hsla(260, 60%, 65%, 0.1) 0%, transparent 50%),
            linear-gradient(0deg, hsla(195, 100%, 50%, 0.08) 1px, transparent 1px),
            linear-gradient(90deg, hsla(195, 100%, 50%, 0.08) 1px, transparent 1px);
        background-size: 100% 100%, 100% 100%, 60px 60px, 60px 60px;
        background-position: 0% 0%, 0% 0%, 0 0, 0 0;
        opacity: 0.9;
        z-index: -2;
        animation: subtle-gradient-shift 20s ease-in-out infinite alternate;
    }

    /* Animated background grid effect - more pronounced */
    .animated-grid {
        position: absolute;
        inset: 0;
        background-image:
            linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
        background-size: 50px 50px;
        z-index: -1;
        animation: pan-grid 60s linear infinite;
        opacity: 0.5;
    }

    @keyframes pan-grid {
        0% { background-position: 0 0; }
        100% { background-position: -50px -50px; }
    }

    /* Scanline effect for retro tech feel */
    body::after {
        content: '';
        position: fixed;
        inset: 0;
        background: repeating-linear-gradient(to bottom,
                transparent 0px,
                transparent 1px,
                rgba(0, 0, 0, 0.03) 1px,
                rgba(0, 0, 0, 0.03) 2px);
        pointer-events: none;
        z-index: 9999;
        opacity: 0.05;
    }

    .container-fluid-custom {
        position: relative;
        z-index: 10;
        padding: 2rem;
    }
    .card-custom {
        background: var(--gradient-glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        box-shadow: var(--shadow-glass);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card-custom:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 45px hsla(222, 47%, 4%, 0.5);
    }

    .card-title-custom {
        font-family: 'Orbitron', sans-serif;
        background: var(--gradient-cyber);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .card-subtitle-custom {
        color: var(--muted-foreground);
    }
    
    .badge-online {
        background-color: var(--accent) !important;
        color: var(--background);
        font-weight: 600;
        animation: pulse 2s infinite;
    }
    .badge-offline {
        background-color: var(--destructive) !important;
        color: var(--foreground);
        font-weight: 600;
    }
    .badge-on {
        background-color: var(--primary) !important;
        color: var(--primary-foreground);
        font-weight: 600;
    }
    .badge-off {
        background-color: var(--destructive) !important;
        color: var(--foreground);
        font-weight: 600;
    }

    .btn-custom {
        padding: 0.8rem 1.8rem;
        border: none;
        border-radius: 0.6rem;
        font-size: 1.05rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        text-decoration: none;
        outline: none;
    }
    .btn-outline-custom {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--foreground);
    }
    .btn-outline-custom:hover {
        border-color: var(--primary);
        background: hsla(195, 100%, 50%, 0.15);
        color: var(--primary);
    }
    .btn-outline-primary-custom {
        background: transparent;
        border: 1px solid var(--primary);
        color: var(--primary);
    }
    .btn-outline-primary-custom:hover {
        background: hsla(195, 100%, 50%, 0.2);
        color: var(--foreground);
    }
    
    .text-light {
        color: var(--foreground) !important;
        font-family: 'Orbitron', sans-serif;
        font-size: 2.5rem;
        background: var(--gradient-cyber);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 2rem;
    }

    /* Animations */
    @keyframes subtle-gradient-shift {
        0% { background-position: 0% 0%, 0% 0%, 0% 0%, 0 0, 0 0; }
        100% { background-position: 100% 100%, 100% 100%, 100% 100%, 100% 100%, 100% 100%; }
    }
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(var(--accent-rgb), 0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(var(--accent-rgb), 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(var(--accent-rgb), 0); }
    }

</style>
{% endblock %}

{% block content %}
<div class="animated-grid"></div>
<div class="container-fluid-custom">
    <h2 class="mb-4 text-light">My Smart Devices</h2>

    {% if devices_with_latest_data %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for item in devices_with_latest_data %}
        <div class="col" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:1 }}00">
            <div class="card-custom h-100 p-4">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title-custom">{{ item.device.name }}</h5>
                    <h6 class="card-subtitle-custom mb-3">{{ item.device.get_device_type_display }}</h6>
                    
                    <p class="mb-2">
                        <strong class="text-white">Status:</strong>
                        {% if item.device.is_online and item.device.last_seen and item.device.last_seen|timesince:"now"|cut:" " < "5 minutes" %}
                            <span class="badge badge-online">Online</span>
                        {% else %}
                            <span class="badge badge-offline">Offline</span>
                        {% endif %}
                    </p>
                    <p class="card-text mb-3" style="font-size: 0.9rem; color: var(--muted-foreground);">
                        Last Seen: {{ item.device.last_seen|default:"N/A" }}
                    </p>

                    <div class="mt-auto">
                        {% if item.device.device_type == 'power_monitor' %}
                            <p class="card-text">
                                <strong class="text-white">Current Power:</strong> <span style="color: var(--primary);">{{ item.latest_data.power|default:"N/A" }}</span> W<br>
                                <strong class="text-white">Voltage:</strong> <span style="color: var(--primary);">{{ item.latest_data.voltage|default:"N/A" }}</span> V<br>
                                <strong class="text-white">Relay State:</strong>
                                {% if item.latest_data.relay_state == "ON" %}
                                    <span class="badge badge-on">ON</span>
                                {% elif item.latest_data.relay_state == "OFF" %}
                                    <span class="badge badge-off">OFF</span>
                                {% else %}
                                    <span class="badge bg-secondary">Unknown</span>
                                {% endif %}
                            </p>
                        {% elif item.device.device_type == 'water_level' %}
                            <p class="card-text">
                                <strong class="text-white">Water Level:</strong> <span style="color: var(--primary);">{{ item.latest_data.water_level|default:"N/A" }}</span>%
                            </p>
                        {% else %}
                            <p class="card-text text-muted">No specific data available for this device type.</p>
                        {% endif %}
                    </div>
                    <a href="{% url 'dashboard:device_detail' item.device.id %}" class="btn-custom btn-outline-primary-custom mt-3">View Details & Control</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info text-center" role="alert" style="background: var(--gradient-glass); border-color: var(--primary); color: var(--foreground);">
        You don't have any devices registered yet. <a href="{% url 'add_device_to_user' %}" class="alert-link" style="color: var(--primary);">Set up a new device</a> to get started!
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true,
            mirror: false
        });
    });
</script>
{% endblock %}