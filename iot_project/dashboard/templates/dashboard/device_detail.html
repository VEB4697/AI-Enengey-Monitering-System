{% extends 'base.html' %}
{% load static %}

{% block title %}{{ device.name }} - Details{% endblock %}

{% block head_extra %}
    <!-- Chart.js for dynamic charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<h2 class="mb-4 text-light">{{ device.name }} ({{ device.get_device_type_display }})</h2>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card shadow-lg bg-dark text-light border-secondary">
            <div class="card-body">
                <h5 class="card-title text-primary">Device Information</h5>
                <p><strong>API Key:</strong> <code class="text-info">{{ device.device_api_key }}</code></p>
                <p><strong>Location:</strong> {{ device.location|default:"Not set" }}</p>
                <p><strong>Status:</strong>
                    {% if device.is_online and device.last_seen and device.last_seen|timesince:"now"|cut:" " < "5 minutes" %}
                        <span class="badge bg-success">Online</span>
                    {% else %}
                        <span class="badge bg-danger">Offline</span>
                    {% endif %}
                </p>
                <p><strong>Last Seen:</strong> {{ device.last_seen|default:"N/A" }}</p>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card shadow-lg bg-dark text-light border-secondary">
            <div class="card-body">
                <h5 class="card-title text-primary">Controls</h5>
                {% if device.device_type == 'power_monitor' %}
                    <p class="lead">Water Pump Control</p>
                    <form id="controlForm" method="post" action="{% url 'dashboard:control_device' device.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="command" id="commandInput">
                        <input type="hidden" name="parameters" id="parametersInput">
                        <button type="button" class="btn btn-lg btn-success me-3" onclick="sendCommand('set_relay_state', 'ON')">Turn ON Pump</button>
                        <button type="button" class="btn btn-lg btn-danger" onclick="sendCommand('set_relay_state', 'OFF')">Turn OFF Pump</button>
                    </form>
                    <div id="controlFeedback" class="mt-3"></div>
                {% elif device.device_type == 'water_level' %}
                    <p class="text-muted">No direct controls for this device type.</p>
                {% else %}
                    <p class="text-muted">Controls not defined for this device type.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-lg bg-dark text-light border-secondary">
            <div class="card-body">
                <h5 class="card-title text-primary">Sensor Data History</h5>
                
                {% if device.device_type == 'power_monitor' and chart_labels and chart_data %}
                    <div style="position: relative; height: 400px; width: 100%;">
                        <canvas id="powerChart"></canvas>
                    </div>
                {% elif device.device_type == 'water_level' and chart_labels and chart_data %}
                    <div style="position: relative; height: 400px; width: 100%;">
                        <canvas id="waterLevelChart"></canvas>
                    </div>
                {% else %}
                    <p class="text-muted">No charts defined or data missing for this device type.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-lg bg-dark text-light border-secondary">
            <div class="card-body">
                <h5 class="card-title text-primary">Raw Data Log (Last 50 Readings)</h5>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-dark table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                {% if device.device_type == 'power_monitor' %}
                                    <th>Voltage (V)</th>
                                    <th>Current (A)</th>
                                    <th>Power (W)</th>
                                    <th>Energy (kWh)</th>
                                    <th>Frequency (Hz)</th>
                                    <th>PF</th>
                                    <th>Relay State</th>
                                {% elif device.device_type == 'water_level' %}
                                    <th>Water Level (%)</th>
                                {% else %}
                                    <th>Raw Data</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for data_entry in sensor_data_entries %}
                            <tr>
                                <td>{{ data_entry.timestamp|date:"Y-m-d H:i:s" }}</td>
                                {% if device.device_type == 'power_monitor' %}
                                    <td>{{ data_entry.data.voltage|floatformat:2 }}</td>
                                    <td>{{ data_entry.data.current|floatformat:2 }}</td>
                                    <td>{{ data_entry.data.power|floatformat:2 }}</td>
                                    <td>{{ data_entry.data.energy|floatformat:2 }}</td>
                                    <td>{{ data_entry.data.frequency|floatformat:2 }}</td>
                                    <td>{{ data_entry.data.pf|floatformat:2 }}</td>
                                    <td><span class="badge {% if data_entry.data.relay_state == 'ON' %}bg-success{% else %}bg-danger{% endif %}">{{ data_entry.data.relay_state }}</span></td>
                                {% elif device.device_type == 'water_level' %}
                                    <td>{{ data_entry.data.water_level|floatformat:2 }}</td>
                                {% else %}
                                    <td>{{ data_entry.data|pprint }}</td> {# pprint is not a Django filter, use json.dumps in view #}
                                {% endif %}
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center">No sensor data available for this device.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    // AJAX for control buttons
    function sendCommand(commandType, state) {
        const commandInput = document.getElementById('commandInput');
        const parametersInput = document.getElementById('parametersInput');
        const controlFeedback = document.getElementById('controlFeedback');

        commandInput.value = commandType;
        parametersInput.value = JSON.stringify({ state: state }); // Parameters for set_relay_state

        const form = document.getElementById('controlForm');
        const formData = new FormData(form);

        controlFeedback.innerHTML = '<div class="alert alert-info">Sending command...</div>';

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken') // Get CSRF token from form
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                controlFeedback.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
            } else {
                controlFeedback.innerHTML = `<div class="alert alert-danger">${data.message || 'Failed to send command.'}</div>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            controlFeedback.innerHTML = '<div class="alert alert-danger">Network error or server unreachable.</div>';
        });
    }

    // Chart.js initialization
    document.addEventListener('DOMContentLoaded', function() {
        const chartLabels = JSON.parse('{{ chart_labels|escapejs }}');
        const chartData = JSON.parse('{{ chart_data|escapejs }}');
        const deviceType = '{{ device.device_type }}';

        if (deviceType === 'power_monitor' && chartLabels.length && chartData && chartData.power) {
    const ctx = document.getElementById('powerChart')?.getContext('2d');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [
                    {
                        label: 'Power (W)',
                        data: chartData.power,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: 'Voltage (V)',
                        data: chartData.voltage,
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: 'Current (A)',
                        data: chartData.current,
                        borderColor: 'rgb(54, 162, 235)',
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: 'Frequency (Hz)',
                        data: chartData.frequency,
                        borderColor: 'rgb(255, 205, 86)',
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: 'Power Factor',
                        data: chartData.pf,
                        borderColor: 'rgb(153, 102, 255)',
                        tension: 0.1,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time',
                            color: '#e0e0e0'
                        },
                        ticks: { color: '#a0aec0' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Value',
                            color: '#e0e0e0'
                        },
                        ticks: { color: '#a0aec0' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#e0e0e0' } },
                    tooltip: {
                        backgroundColor: 'rgba(44, 62, 80, 0.8)',
                        titleColor: '#e0e0e0',
                        bodyColor: '#e0e0e0'
                    }
                }
            }
        });
    }
}

        // Add else if for other device types to initialize their specific charts
        // else if (deviceType === 'water_level') { ... }
    });
</script>
{% endblock %}